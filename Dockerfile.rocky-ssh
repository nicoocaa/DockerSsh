# Dockerfile.rocky-ssh-secure
FROM rockylinux:9

# Met √† jour les paquets et installe OpenSSH, sudo et utilitaires
RUN dnf -y update && \
    dnf -y install \
    openssh-server \
    sudo \
    nano \
    git \
    passwd \
    pam \
    util-linux \
    shadow-utils && \
    dnf clean all

# Cr√©e les dossiers n√©cessaires
RUN mkdir /var/run/sshd

# G√©n√®re les cl√©s SSH server
RUN ssh-keygen -A

# Cr√©e un utilisateur non-root avec un mot de passe
RUN useradd -m -s /bin/bash dockeruser && \
    echo "dockeruser:changeme" | chpasswd && \
    usermod -aG wheel dockeruser && \
    touch /home/dockeruser/.hushlogin

# Active les logs SSH pour debug
RUN echo "LogLevel VERBOSE" >> /etc/ssh/sshd_config

# Active la banni√®re SSH
RUN echo "Banner /etc/issue.net" >> /etc/ssh/sshd_config

# Cr√©e une banni√®re et un motd simple
RUN echo "üêß Bienvenue sur la VM Rocky SSH s√©curis√©e" > /etc/issue.net && \
    echo -e '#!/bin/bash\n' \
    'echo "üë§ Utilisateur : $(whoami)"\n' \
    'echo "üïí Date       : $(date)"\n' \
    'echo "üì° IP interne : $(hostname -I)"' \
    > /etc/profile.d/custom_motd.sh && \
    chmod +x /etc/profile.d/custom_motd.sh

# S√©curise SSH : d√©sactive root + autorise dockeruser
RUN sed -i 's/^#PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config && \
    echo 'AllowUsers dockeruser' >> /etc/ssh/sshd_config && \
    sed -i 's/^#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Cr√©e le dossier SSH de l'utilisateur
RUN mkdir -p /home/dockeruser/.ssh && \
    chown -R dockeruser:dockeruser /home/dockeruser && \
    chmod 700 /home/dockeruser/.ssh

# Expose le port SSH
EXPOSE 22

# D√©marre le service SSH
CMD ["/usr/sbin/sshd", "-D"]

