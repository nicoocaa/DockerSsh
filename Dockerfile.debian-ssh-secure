# Dockerfile.debian-ssh-secure
FROM debian:latest

# Met √† jour les paquets et installe openssh-server, sudo et utilitaires n√©cessaires
RUN apt update && apt install -y \
    openssh-server \
    sudo \
    nano \
    git \
    passwd \
    libpam-modules \
    && mkdir /var/run/sshd

# Cr√©e un utilisateur non-root avec un mot de passe
RUN useradd -m -s /bin/bash dockeruser && \
    usermod --shell /bin/bash dockeruser && \
    echo "dockeruser:changeme" | chpasswd && \
    adduser dockeruser sudo && \
    touch /home/dockeruser/.hushlogin

# Active les logs SSH pour debug (facultatif mais utile)
RUN echo "LogLevel VERBOSE" >> /etc/ssh/sshd_config

# Active la banni√®re SSH
RUN echo "Banner /etc/issue.net" >> /etc/ssh/sshd_config

# Cr√©e un message de bienvenue simple
RUN echo '#!/bin/bash' > /etc/update-motd.d/99-custom && \
    echo 'echo "üêß Bienvenue sur la VM Debian SSH s√©curis√©e"' >> /etc/update-motd.d/99-custom && \
    echo 'echo "üë§ Utilisateur : $(whoami)"' >> /etc/update-motd.d/99-custom && \
    echo 'echo "üïí Date       : $(date)"' >> /etc/update-motd.d/99-custom && \
    echo 'echo "üì° IP interne : $(hostname -I)"' >> /etc/update-motd.d/99-custom && \
    chmod +x /etc/update-motd.d/99-custom

# S√©curise SSH : d√©sactive root + autorise dockeruser
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config && \
    echo 'AllowUsers dockeruser' >> /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Cr√©e le dossier SSH de l'utilisateur
RUN mkdir -p /home/dockeruser/.ssh && \
    chown -R dockeruser:dockeruser /home/dockeruser && \
    chmod 700 /home/dockeruser/.ssh

# Expose port SSH
EXPOSE 22

# Lance le service SSH
CMD ["/usr/sbin/sshd", "-D"]

